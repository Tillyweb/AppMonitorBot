<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard My BOT Trading</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 CDN for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js CDN for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA; /* Light background */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column; /* Allows content to stack and push down */
            align-items: center;
            justify-content: flex-start; /* Align content to the top */
            padding: 1rem; /* Consistent padding around the main content */
            position: relative; /* For stacking with 3D canvas */
            z-index: 1; /* Ensure body content is above 3D canvas */
        }
        .soft-blue { background-color: #E0F2F7; } /* A light blue */
        .soft-green { background-color: #E6F4EA; } /* A light green */
        .soft-yellow { background-color: #FFFDE7; } /* A light yellow */

        /* Button hover effects */
        .btn-modern {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: none;
            cursor: pointer; /* Add pointer cursor for better UX */
        }
        .btn-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transition: all 0.75s ease-out;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            z-index: 0;
        }
        .btn-modern:hover::before {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .btn-modern span {
            position: relative;
            z-index: 1;
        }

        /* 3D Canvas Styles */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2; /* Position behind everything else */
            display: block;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4">

    <!-- Three.js Canvas for 3D Emojis -->
    <canvas id="three-canvas"></canvas>

    <div id="dashboard-page" class="soft-blue rounded-xl shadow-lg p-4 md:p-8 w-full max-w-5xl transition-all duration-300">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 md:mb-8 text-gray-800">Dashboard My BOT Trading</h1>

        <div class="flex flex-col md:flex-row items-center justify-center mb-6 md:mb-8 gap-4">
            <button id="update-data-btn" class="btn-modern bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 w-full md:w-auto">
                <span>อัพเดทข้อมูล</span>
            </button>
            <button id="input-data-page-btn" class="btn-modern bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 w-full md:w-auto">
                <span>Input Data</span>
            </button>
        </div>

        <!-- New Filter Section -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8 flex flex-col md:flex-row items-center justify-center gap-4">
            <label for="month-filter" class="block text-gray-700 text-sm font-bold">กรองข้อมูลตามเดือน:</label>
            <select id="month-filter" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors w-full md:w-auto">
                <option value="all">ทั้งหมด</option>
                <!-- Months will be populated here by JavaScript -->
            </select>
            <button id="apply-filter-btn" class="btn-modern bg-purple-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 w-full md:w-auto">
                <span>ใช้ตัวกรอง</span>
            </button>
        </div>

        <!-- Section 1: Data Table (now the primary display) -->
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
            <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700">ข้อมูลการเทรด (USDT Balance)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-left text-gray-600 uppercase text-xs md:text-sm leading-normal">
                            <th class="py-2 px-4 md:py-3 md:px-6 text-left">วันที่</th>
                            <th class="py-2 px-4 md:py-3 md:px-6 text-left">USDT Balance</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="text-gray-700 text-xs md:text-sm font-light">
                        <!-- Data will be inserted here -->
                        <tr><td colspan="2" class="text-center py-4">กำลังโหลดข้อมูล...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="input-page" class="soft-green rounded-xl shadow-lg p-4 md:p-8 w-full max-w-lg transition-all duration-300 hidden">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8 text-gray-800">กรอกข้อมูลการเทรดรายวัน</h1>

        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-8">
            <div class="mb-4">
                <label for="date-select" class="block text-gray-700 text-sm font-bold mb-2">เลือกวันที่:</label>
                <select id="date-select" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors">
                    <!-- Dates will be populated by JavaScript -->
                </select>
            </div>

            <div class="mb-4">
                <label for="celo-input" class="block text-gray-700 text-sm font-bold mb-2">Celo (%):</label>
                <input type="number" id="celo-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="กรอกข้อมูล Celo เป็น %">
            </div>

            <div class="mb-4">
                <label for="enj-input" class="block text-gray-700 text-sm font-bold mb-2">ENJ (%):</label>
                <input type="number" id="enj-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="กรอกข้อมูล ENJ เป็น %">
            </div>

            <div class="mb-4">
                <label for="wld-input" class="block text-gray-700 text-sm font-bold mb-2">WLD (%):</label>
                <input type="number" id="wld-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="กรอกข้อมูล WLD เป็น %">
            </div>

            <div class="mb-6">
                <label for="rune-input" class="block text-gray-700 text-sm font-bold mb-2">RUNE (%):</label>
                <input type="number" id="rune-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="กรอกข้อมูล RUNE เป็น %">
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <button id="save-data-btn" class="btn-modern bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-300 w-full md:flex-1">
                    <span>บันทึก</span>
                </button>
                <button id="back-to-dashboard-btn" class="btn-modern bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 w-full md:flex-1">
                    <span>กลับหน้าหลัก</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script URL (replace if you deploy your own script)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby7N_Pm56WUz7fl82yZgPwzJC4pRfN4gWGdios5A1rJ0yT31IifkhrPIp_VfXx2fJxG/exec';

        const dashboardPage = document.getElementById('dashboard-page');
        const inputPage = document.getElementById('input-page');
        const updateDataBtn = document.getElementById('update-data-btn');
        const inputDataPageBtn = document.getElementById('input-data-page-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const saveDataBtn = document.getElementById('save-data-btn');
        const dataTableBody = document.getElementById('data-table-body');
        // Removed usdtChartCanvas and Chart.js related elements

        const dateSelect = document.getElementById('date-select');
        const celoInput = document.getElementById('celo-input');
        const enjInput = document.getElementById('enj-input');
        const wldInput = document.getElementById('wld-input');
        const runeInput = document.getElementById('rune-input');

        // Elements for month filter
        const monthFilterSelect = document.getElementById('month-filter');
        const applyFilterBtn = document.getElementById('apply-filter-btn');

        let allDashboardData = []; // Global variable to store raw data for filtering

        // --- Three.js setup for 3D Emojis ---
        let scene, camera, renderer, objects = [];
        const colors = [0xE0F2F7, 0xE6F4EA, 0xFFFDE7, 0x64B5F6, 0x81C784, 0xFFD54F, 0x4DB6AC, 0x7986CB]; // Soft tones and some brighter ones

        function initThree() {
            const threeCanvas = document.getElementById('three-canvas');
            if (!threeCanvas) {
                console.error("Three.js canvas not found.");
                return;
            }

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, alpha: true, antialias: true }); // alpha: true for transparent background
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Add some light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); // soft white light
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 1).normalize();
            scene.add(directionalLight);

            // Create 3D "emojis" (simple geometric shapes)
            const geometries = [
                new THREE.SphereGeometry(1, 32, 32),
                new THREE.BoxGeometry(1.5, 1.5, 1.5),
                new THREE.TetrahedronGeometry(1.2),
                new THREE.TorusGeometry(1, 0.4, 16, 100)
            ];

            for (let i = 0; i < 12; i++) {
                const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                const material = new THREE.MeshLambertMaterial({ color: colors[Math.floor(Math.random() * colors.length)] });
                const object = new THREE.Mesh(geometry, material);

                // Random position within a certain range
                object.position.x = (Math.random() - 0.5) * 40;
                object.position.y = (Math.random() - 0.5) * 40;
                object.position.z = (Math.random() - 0.5) * 20 - 5; // Slightly behind the content

                // Random rotation
                object.rotation.x = Math.random() * Math.PI;
                object.rotation.y = Math.random() * Math.PI;
                object.rotation.z = Math.random() * Math.PI;

                // Random scale
                const scale = Math.random() * 0.8 + 0.5; // Scale between 0.5 and 1.3
                object.scale.set(scale, scale, scale);

                object.initialY = object.position.y; // Store initial Y for floating animation
                object.animationSpeed = (Math.random() * 0.005) + 0.001; // Vary speed
                object.rotationSpeedX = (Math.random() - 0.5) * 0.005;
                object.rotationSpeedY = (Math.random() - 0.5) * 0.005;

                scene.add(object);
                objects.push(object);
            }

            camera.position.z = 5; // Adjust camera to see objects
        }

        function animateThree() {
            requestAnimationFrame(animateThree);

            objects.forEach(object => {
                // Float up (Y-axis)
                object.position.y += object.animationSpeed;
                // If object goes too high, reset to bottom
                if (object.position.y > (window.innerHeight / 20) + 10) { // Reset based on screen height
                    object.position.y = -(window.innerHeight / 20) - 10;
                    object.position.x = (Math.random() - 0.5) * 40; // Randomize X on reset
                    object.position.z = (Math.random() - 0.5) * 20 - 5; // Randomize Z on reset
                }

                // Rotate
                object.rotation.x += object.rotationSpeedX;
                object.rotation.y += object.rotationSpeedY;
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);
        window.onload = function() {
            initThree();
            animateThree();
            // Initial load for dashboard data
            const cachedData = localStorage.getItem('dashboardData');
            if (cachedData) {
                allDashboardData = JSON.parse(cachedData);
                populateMonthFilter(allDashboardData);
                applyFilter();
                console.log('ข้อมูลจาก Local Storage โหลดแล้ว');
            } else {
                fetchData();
            }
        };

        // --- End Three.js setup ---


        // Function to format date for display (DD/MM/YYYY)
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) { // Check for invalid date
                // Attempt to parse as ISO 8601 (YYYY-MM-DD) if it's a string
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const parsedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    if (!isNaN(parsedDate.getTime())) {
                        return parsedDate.toLocaleDateString('th-TH');
                    }
                }
                return dateString; // Return original if parsing failed
            }
            return date.toLocaleDateString('th-TH');
        };

        // Function to render data to table
        const renderDashboard = (data) => {
            // Clear existing table data
            dataTableBody.innerHTML = '';
            if (!data || data.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="2" class="text-center py-4">ไม่มีข้อมูล</td></tr>';
                return;
            }

            // Sort data by date from newest to oldest
            data.sort((a, b) => {
                const dateA = new Date(a['DATE']);
                const dateB = new Date(b['DATE']);
                return dateB - dateA; // Changed sorting order here
            });

            data.forEach(row => {
                const date = row['DATE']; // Assuming column name is 'DATE'
                const usdt = row['USDT']; // Assuming column name is 'USDT'

                // Add to table
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-2 px-4 md:py-3 md:px-6 text-left whitespace-nowrap">${formatDate(date)}</td>
                    <td class="py-2 px-4 md:py-3 md:px-6 text-left">${usdt !== undefined ? usdt.toLocaleString() : '-'}</td>
                `;
                dataTableBody.appendChild(tr);
            });
        };

        // Function to populate the month filter dropdown
        const populateMonthFilter = (data) => {
            const months = new Set();
            data.forEach(row => {
                if (row['DATE']) {
                    const date = new Date(row['DATE']);
                    // Attempt to parse as ISO 8601 (YYYY-MM-DD) if it's a string
                    if (isNaN(date.getTime())) {
                        const parts = row['DATE'].split('-');
                        if (parts.length === 3) {
                            const parsedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                            if (!isNaN(parsedDate.getTime())) {
                                months.add(`${parsedDate.getFullYear()}-${parsedDate.getMonth() + 1}`);
                            }
                        }
                    } else {
                        months.add(`${date.getFullYear()}-${date.getMonth() + 1}`);
                    }
                }
            });

            // Clear previous options except "All"
            monthFilterSelect.innerHTML = '<option value="all">ทั้งหมด</option>';

            const sortedMonths = Array.from(months).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                const dateForMonthName = new Date(year, month - 1, 1);
                const monthName = dateForMonthName.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                monthFilterSelect.appendChild(option);
            });
        };

        // Function to apply the filter
        const applyFilter = () => {
            const selectedMonth = monthFilterSelect.value;
            let filteredData = allDashboardData;

            if (selectedMonth !== 'all') {
                filteredData = allDashboardData.filter(row => {
                    if (row['DATE']) {
                        const date = new Date(row['DATE']);
                        // Re-attempt parsing for consistency
                        if (isNaN(date.getTime())) {
                            const parts = row['DATE'].split('-');
                            if (parts.length === 3) {
                                const parsedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                if (!isNaN(parsedDate.getTime())) {
                                    return `${parsedDate.getFullYear()}-${parsedDate.getMonth() + 1}` === selectedMonth;
                                }
                            }
                            return false; // Invalid date format
                        }
                        return `${date.getFullYear()}-${date.getMonth() + 1}` === selectedMonth;
                    }
                    return false;
                });
            }
            renderDashboard(filteredData);
        };

        // Function to fetch data for the input fields based on selected date
        const loadInputDataForDate = () => {
            const selectedDate = dateSelect.value;
            if (!selectedDate) {
                // Clear fields if no date is selected
                celoInput.value = '';
                enjInput.value = '';
                wldInput.value = '';
                runeInput.value = '';
                return;
            }

            // Create a unique callback name for JSONP
            const callbackName = 'jsonpInputCallback_' + Date.now();
            window[callbackName] = (response) => {
                if (response && response.data) {
                    const data = response.data;
                    // Populate fields. If data is null, ensure fields are cleared.
                    celoInput.value = data.celo !== null ? (data.celo * 100).toFixed(2) : ''; // Convert back to percentage for display
                    enjInput.value = data.enj !== null ? (data.enj * 100).toFixed(2) : '';
                    wldInput.value = data.wld !== null ? (data.wld * 100).toFixed(2) : '';
                    runeInput.value = data.rune !== null ? (data.rune * 100).toFixed(2) : '';
                } else {
                    // Clear fields if no data or error
                    celoInput.value = '';
                    enjInput.value = '';
                    wldInput.value = '';
                    runeInput.value = '';
                }
                // Clean up the script tag and callback
                document.body.removeChild(script);
                delete window[callbackName];
            };

            const script = document.createElement('script');
            // Add sheetName and date parameters for Apps Script to handle
            script.src = `${SCRIPT_URL}?sheetName=Input!&date=${selectedDate}&callback=${callbackName}`;
            script.onerror = () => {
                console.error('Failed to load input data for date:', selectedDate);
                // Clear fields on error
                celoInput.value = '';
                enjInput.value = '';
                wldInput.value = '';
                runeInput.value = '';
                document.body.removeChild(script);
                delete window[callbackName];
            };
            document.body.appendChild(script);
        };


        // Function to fetch data from Google Sheet using JSONP (for Dashboard)
        const fetchData = () => {
            Swal.fire({
                title: 'กำลังอัพเดทข้อมูล...',
                html: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const callbackName = 'jsonpCallback_' + Date.now();
            window[callbackName] = (response) => {
                if (response && response.data) {
                    allDashboardData = response.data; // Store raw data
                    localStorage.setItem('dashboardData', JSON.stringify(allDashboardData));
                    populateMonthFilter(allDashboardData); // Populate filter with new data
                    applyFilter(); // Apply filter to render initial view (default to "all")
                    Swal.fire({
                        icon: 'success',
                        title: 'อัพเดทข้อมูลสำเร็จ!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด!',
                        text: 'ไม่สามารถโหลดข้อมูลได้',
                    });
                }
                document.body.removeChild(script);
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?callback=${callbackName}`;
            script.onerror = () => {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถเชื่อมต่อกับ Google Sheet ได้',
                });
                document.body.removeChild(script);
                delete window[callbackName];
            };
            document.body.appendChild(script);
        };

        // Populate date dropdown for the entire year
        const populateDateDropdown = () => {
            const today = new Date();
            const currentYear = today.getFullYear();
            dateSelect.innerHTML = ''; // Clear previous options

            for (let month = 0; month < 12; month++) {
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, month, day);
                    const formattedDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
                    const displayDate = date.toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const option = document.createElement('option');
                    option.value = formattedDate;
                    option.textContent = displayDate;
                    dateSelect.appendChild(option);
                }
            }
            // Set default selected date to today
            dateSelect.value = today.toISOString().split('T')[0];
            loadInputDataForDate(); // Load data for the default selected date
        };

        // Event Listeners
        updateDataBtn.addEventListener('click', fetchData);
        applyFilterBtn.addEventListener('click', applyFilter); // Add event listener for the new filter button
        dateSelect.addEventListener('change', loadInputDataForDate); // Listen for date changes

        inputDataPageBtn.addEventListener('click', () => {
            dashboardPage.classList.add('hidden');
            inputPage.classList.remove('hidden');
            populateDateDropdown(); // Populate dropdown and load data for current date when navigating to input page
        });

        backToDashboardBtn.addEventListener('click', () => {
            inputPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            applyFilter(); // Re-apply filter when returning to dashboard to ensure correct display
        });

        saveDataBtn.addEventListener('click', async () => {
            const selectedDate = dateSelect.value;
            const celo = celoInput.value;
            const enj = enjInput.value;
            const wld = wldInput.value;
            const rune = runeInput.value;

            if (!selectedDate || !celo || !enj || !wld || !rune) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วน!',
                    text: 'ตรวจสอบให้แน่ใจว่าได้กรอกทุกช่องแล้ว',
                });
                return;
            }

            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                html: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        date: selectedDate,
                        // คูณด้วย 0.01 ก่อนนำไปกรอกข้อมูล
                        celo: parseFloat(celo) * 0.01,
                        enj: parseFloat(enj) * 0.01,
                        wld: parseFloat(wld) * 0.01,
                        rune: parseFloat(rune) * 0.01
                    }).toString()
                });

                const result = await response.json();

                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    // Optionally clear inputs after successful save
                    // celoInput.value = ''; // Don't clear if user might want to continue editing for the same date
                    // enjInput.value = '';
                    // wldInput.value = '';
                    // runeInput.value = '';

                    // After saving, re-fetch data to update dashboard immediately and also input fields
                    fetchData(); // This will refresh dashboard table
                    loadInputDataForDate(); // This will refresh input fields for the currently selected date
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด!',
                        text: result.message || 'ไม่สามารถบันทึกข้อมูลได้',
                    });
                }
            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถเชื่อมต่อกับ Google Sheet ได้: ' + error.message,
                });
            }
        });

        // Initial load for dashboard data (moved to window.onload)
        // document.addEventListener('DOMContentLoaded', () => {
        //     const cachedData = localStorage.getItem('dashboardData');
        //     if (cachedData) {
        //         allDashboardData = JSON.parse(cachedData); // Load raw data from cache
        //         populateMonthFilter(allDashboardData); // Populate filter from cached data
        //         applyFilter(); // Apply filter to render initial view (default to "all")
        //         console.log('ข้อมูลจาก Local Storage โหลดแล้ว');
        //     } else {
        //         fetchData(); // Fetch if no cached data
        //     }
        // });
    </script>
</body>
</html>
