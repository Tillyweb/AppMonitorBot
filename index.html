<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard My BOT Trading</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 CDN for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA; /* Light background */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column; /* Allows content to stack and push down */
            align-items: center;
            justify-content: flex-start; /* Align content to the top */
            padding: 1rem; /* Consistent padding around the main content */
            overflow: hidden; /* Hide scrollbar caused by floating emojis */
        }
        .soft-blue { background-color: #E0F2F7; } /* A light blue */
        .soft-green { background-color: #E6F4EA; } /* A light green */
        .soft-yellow { background-color: #FFFDE7; } /* A light yellow */

        /* Button hover effects */
        .btn-modern {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: none;
            cursor: pointer; /* Add pointer cursor for better UX */
        }
        .btn-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transition: all 0.75s ease-out;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            z-index: 0;
        }
        .btn-modern:hover::before {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .btn-modern span {
            position: relative;
            z-index: 1;
        }

        /* Floating Emojis Animation */
        @keyframes floatUp {
            0% {
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg) scale(1.5);
                opacity: 0;
            }
        }

        .emoji-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden; /* Keep emojis within their container */
            z-index: -1;
        }

        .emoji {
            position: absolute;
            font-size: 3rem; /* Larger emojis */
            animation: floatUp linear infinite;
            opacity: 0; /* Start hidden */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* Specific emoji animation delays and positions */
        .emoji:nth-child(1) { animation-delay: 0s; left: 10%; animation-duration: 25s; }
        .emoji:nth-child(2) { animation-delay: 2s; left: 20%; animation-duration: 20s; }
        .emoji:nth-child(3) { animation-delay: 4s; left: 30%; animation-duration: 22s; }
        .emoji:nth-child(4) { animation-delay: 6s; left: 40%; animation-duration: 28s; }
        .emoji:nth-child(5) { animation-delay: 8s; left: 50%; animation-duration: 23s; }
        .emoji:nth-child(6) { animation-delay: 10s; left: 60%; animation-duration: 26s; }
        .emoji:nth-child(7) { animation-delay: 12s; left: 70%; animation-duration: 21s; }
        .emoji:nth-child(8) { animation-delay: 14s; left: 80%; animation-duration: 24s; }
        .emoji:nth-child(9) { animation-delay: 16s; left: 90%; animation-duration: 27s; }
        .emoji:nth-child(10) { animation-delay: 18s; left: 5%; animation-duration: 19s; }
        .emoji:nth-child(11) { animation-delay: 20s; left: 15%; animation-duration: 29s; }
        .emoji:nth-child(12) { animation-delay: 22s; left: 25%; animation-duration: 20s; }
        .emoji:nth-child(13) { animation-delay: 24s; left: 35%; animation-duration: 25s; }
        .emoji:nth-child(14) { animation-delay: 26s; left: 45%; animation-duration: 21s; }
        .emoji:nth-child(15) { animation-delay: 28s; left: 55%; animation-duration: 28s; }
        .emoji:nth-child(16) { animation-delay: 30s; left: 65%; animation-duration: 23s; }
        .emoji:nth-child(17) { animation-delay: 32s; left: 75%; animation-duration: 26s; }
        .emoji:nth-child(18) { animation-delay: 34s; left: 85%; animation-duration: 20s; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4">

    <!-- Emoji Container -->
    <div class="emoji-container">
        <div class="emoji" style="color: #64B5F6;">üìà</div>
        <div class="emoji" style="color: #81C784;">üí∞</div>
        <div class="emoji" style="color: #FFD54F;">üìä</div>
        <div class="emoji" style="color: #4DB6AC;">üöÄ</div>
        <div class="emoji" style="color: #7986CB;">üí∏</div>
        <div class="emoji" style="color: #FF8A65;">üí°</div>
        <div class="emoji" style="color: #A1887F;">üíé</div>
        <div class="emoji" style="color: #C5E1A5;">‚ú®</div>
        <div class="emoji" style="color: #EF9A9A;">üíπ</div>
        <div class="emoji" style="color: #B39DDB;">üçÄ</div>
        <div class="emoji" style="color: #FFEB3B;">üåü</div>
        <div class="emoji" style="color: #8BC34A;">üå±</div>
        <div class="emoji" style="color: #FF6F61;">üíñ</div>
        <div class="emoji" style="color: #A7FFEB;">üéâ</div>
        <div class="emoji" style="color: #D1C4E9;">üîî</div>
        <div class="emoji" style="color: #FFCC80;">üìà</div>
        <div class="emoji" style="color: #8D6E63;">üí±</div>
        <div class="emoji" style="color: #C0CA33;">üëë</div>
    </div>

    <div id="dashboard-page" class="soft-blue rounded-xl shadow-lg p-4 md:p-8 w-full max-w-5xl transition-all duration-300">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 md:mb-8 text-gray-800">Dashboard My BOT Trading</h1>

        <div class="flex flex-col md:flex-row items-center justify-center mb-6 md:mb-8 gap-4">
            <button id="update-data-btn" class="btn-modern bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 w-full md:w-auto">
                <span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
            <button id="input-data-page-btn" class="btn-modern bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 w-full md:w-auto">
                <span>Input Data</span>
            </button>
        </div>

        <!-- New Filter Section -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8 flex flex-col md:flex-row items-center justify-center gap-4">
            <label for="month-filter" class="block text-gray-700 text-sm font-bold">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
            <select id="month-filter" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors w-full md:w-auto">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <!-- Months will be populated here by JavaScript -->
            </select>
            <button id="apply-filter-btn" class="btn-modern bg-purple-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 w-full md:w-auto">
                <span>‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</span>
            </button>
        </div>

        <!-- New Small Table Section -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8">
            <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å CACULATE!</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-left text-gray-600 uppercase text-xs md:text-sm leading-normal">
                            <th class="py-2 px-4 text-left">‡πÅ‡∏ñ‡∏ß</th>
                            <th class="py-2 px-4 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Demodate)</th>
                            <th class="py-2 px-4 text-left">‡∏Ñ‡πà‡∏≤ (DemoUSDT)</th>
                        </tr>
                    </thead>
                    <tbody id="specific-caculate-data-body" class="text-gray-700 text-xs md:text-sm font-light">
                        <tr><td colspan="3" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section 1: Data Table (now the primary display) -->
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
            <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î (USDT Balance)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-left text-gray-600 uppercase text-xs md:text-sm leading-normal">
                            <th class="py-2 px-4 md:py-3 md:px-6 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="py-2 px-4 md:py-3 md:px-6 text-left">USDT Balance</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="text-gray-700 text-xs md:text-sm font-light">
                        <!-- Data will be inserted here -->
                        <tr><td colspan="2" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="input-page" class="soft-green rounded-xl shadow-lg p-4 md:p-8 w-full max-w-lg transition-all duration-300 hidden">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8 text-gray-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>

        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-8">
            <div class="mb-4">
                <label for="date-select" class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                <select id="date-select" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors">
                    <!-- Dates will be populated by JavaScript -->
                </select>
            </div>

            <div class="mb-4">
                <label for="celo-input" class="block text-gray-700 text-sm font-bold mb-2">Celo (%):</label>
                <input type="number" id="celo-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Celo ‡πÄ‡∏õ‡πá‡∏ô %">
            </div>

            <div class="mb-4">
                <label for="enj-input" class="block text-gray-700 text-sm font-bold mb-2">ENJ (%):</label>
                <input type="number" id="enj-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ENJ ‡πÄ‡∏õ‡πá‡∏ô %">
            </div>

            <div class="mb-4">
                <label for="wld-input" class="block text-gray-700 text-sm font-bold mb-2">WLD (%):</label>
                <input type="number" id="wld-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• WLD ‡πÄ‡∏õ‡πá‡∏ô %">
            </div>

            <div class="mb-6">
                <label for="rune-input" class="block text-gray-700 text-sm font-bold mb-2">RUNE (%):</label>
                <input type="number" id="rune-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 md:py-3 md:px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition-colors" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RUNE ‡πÄ‡∏õ‡πá‡∏ô %">
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <button id="save-data-btn" class="btn-modern bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-300 w-full md:flex-1">
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </button>
                <button id="back-to-dashboard-btn" class="btn-modern bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 w-full md:flex-1">
                    <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script URL (replace if you deploy your own script)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby7N_Pm56WUz7fl82yZgPwzJC4pRfN4gWGdios5A1rJ0yT31IifkhrPIp_VfXx2fJxG/exec';

        const dashboardPage = document.getElementById('dashboard-page');
        const inputPage = document.getElementById('input-page');
        const updateDataBtn = document.getElementById('update-data-btn');
        const inputDataPageBtn = document.getElementById('input-data-page-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const saveDataBtn = document.getElementById('save-data-btn');
        const dataTableBody = document.getElementById('data-table-body');
        
        const dateSelect = document.getElementById('date-select');
        const celoInput = document.getElementById('celo-input');
        const enjInput = document.getElementById('enj-input');
        const wldInput = document.getElementById('wld-input');
        const runeInput = document.getElementById('rune-input');

        // Elements for month filter
        const monthFilterSelect = document.getElementById('month-filter');
        const applyFilterBtn = document.getElementById('apply-filter-btn');

        // New elements for specific CACULATE! data table
        const specificCaculateDataBody = document.getElementById('specific-caculate-data-body');

        let allDashboardData = []; // Global variable to store raw data for filtering


        // Function to format date for display (DD/MM/BBBB - Buddhist year)
        const formatDate = (dateString) => {
            if (!dateString) return '';
            let date = new Date(dateString);

            // Attempt to parse as YYYY-MM-DD if initial parsing failed or yielded invalid date
            if (isNaN(date.getTime())) {
                const parts = String(dateString).split('-'); // Ensure dateString is treated as string
                if (parts.length === 3) {
                    // new Date(year, monthIndex, day)
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
            }

            if (isNaN(date.getTime())) { // If still invalid after retry
                return dateString; // Return original string if parsing failed
            }

            // Get Gregorian year
            const gregorianYear = date.getFullYear();
            // Calculate Buddhist year
            const buddhistYear = gregorianYear + 543; // Add 543 for Thai Buddhist calendar

            // Get day and month, pad with leading zero if single digit
            const day = date.getDate();
            const month = date.getMonth() + 1; // Month is 0-indexed, so add 1
            const formattedMonth = month < 10 ? '0' + month : month;
            const formattedDay = day < 10 ? '0' + day : day;

            // Construct the date string manually as DD/MM/BBBB (Buddhist year)
            return `${formattedDay}/${formattedMonth}/${buddhistYear}`;
        };

        // Function to render data to main table
        const renderDashboard = (data) => {
            // Clear existing table data
            dataTableBody.innerHTML = '';
            if (!data || data.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="2" class="text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }

            // Sort data by date from newest to oldest for table display
            data.sort((a, b) => {
                const dateA = new Date(a['DATE']);
                const dateB = new Date(b['DATE']);
                return dateB - dateA;
            });

            data.forEach(row => {
                const date = row['DATE']; // Assuming column name is 'DATE'
                const usdt = row['USDT']; // Assuming column name is 'USDT'

                // Add to table
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-2 px-4 md:py-3 md:px-6 text-left whitespace-nowrap">${formatDate(date)}</td>
                    <td class="py-2 px-4 md:py-3 md:px-6 text-left">${usdt !== undefined ? Math.round(usdt).toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '-'}</td>
                `; // Rounded and no decimals for table

                dataTableBody.appendChild(tr);
            });
        };

        // Function to populate the month filter dropdown
        const populateMonthFilter = (data) => {
            const months = new Set();
            data.forEach(row => {
                if (row['DATE']) {
                    const date = new Date(row['DATE']);
                    // Attempt to parse as YYYY-MM-DD if it's a string
                    if (isNaN(date.getTime())) {
                        const parts = row['DATE'].split('-');
                        if (parts.length === 3) {
                            const parsedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                            if (!isNaN(parsedDate.getTime())) {
                                months.add(`${parsedDate.getFullYear()}-${parsedDate.getMonth() + 1}`);
                            }
                        }
                    } else {
                        months.add(`${date.getFullYear()}-${date.getMonth() + 1}`);
                    }
                }
            });

            // Clear previous options except "All"
            monthFilterSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';

            const sortedMonths = Array.from(months).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                return monthA - monthB;
            });

            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                const dateForMonthName = new Date(year, month - 1, 1);
                // Ensure the month name displays the Buddhist year here too
                const monthName = dateForMonthName.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                monthFilterSelect.appendChild(option);
            });
        };

        // Function to apply the filter
        const applyFilter = () => {
            const selectedMonth = monthFilterSelect.value;
            let filteredData = allDashboardData;

            if (selectedMonth !== 'all') {
                filteredData = allDashboardData.filter(row => {
                    if (row['DATE']) {
                        const date = new Date(row['DATE']);
                        // Re-attempt parsing for consistency
                        if (isNaN(date.getTime())) {
                            const parts = row['DATE'].split('-');
                            if (parts.length === 3) {
                                const parsedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                if (!isNaN(parsedDate.getTime())) {
                                    return `${parsedDate.getFullYear()}-${parsedDate.getMonth() + 1}` === selectedMonth;
                                }
                            }
                            return false; // Invalid date format
                        }
                        return `${date.getFullYear()}-${date.getMonth() + 1}` === selectedMonth;
                    }
                    return false;
                });
            }
            renderDashboard(filteredData);
        };

        // Function to fetch data for the input fields based on selected date
        const loadInputDataForDate = () => {
            const selectedDate = dateSelect.value;
            if (!selectedDate) {
                // Clear fields if no date is selected
                celoInput.value = '';
                enjInput.value = '';
                wldInput.value = '';
                runeInput.value = '';
                return;
            }

            // Create a unique callback name for JSONP
            const callbackName = 'jsonpInputCallback_' + Date.now();
            window[callbackName] = (response) => {
                if (response && response.data) {
                    const data = response.data;
                    // Populate fields. If data is null, ensure fields are cleared.
                    celoInput.value = data.celo !== null ? (data.celo * 100).toFixed(2) : ''; // Convert back to percentage for display
                    enjInput.value = data.enj !== null ? (data.enj * 100).toFixed(2) : '';
                    wldInput.value = data.wld !== null ? (data.wld * 100).toFixed(2) : '';
                    runeInput.value = data.rune !== null ? (data.rune * 100).toFixed(2) : '';
                } else {
                    // Clear fields if no data or error
                    celoInput.value = '';
                    enjInput.value = '';
                    wldInput.value = '';
                    runeInput.value = '';
                }
                // Clean up the script tag and callback
                document.body.removeChild(script);
                delete window[callbackName];
            };

            const script = document.createElement('script');
            // Add sheetName and date parameters for Apps Script to handle
            script.src = `${SCRIPT_URL}?sheetName=Input!&date=${selectedDate}&callback=${callbackName}`;
            script.onerror = () => {
                console.error('Failed to load input data for date:', selectedDate);
                // Clear fields on error
                celoInput.value = '';
                enjInput.value = '';
                wldInput.value = '';
                runeInput.value = '';
                document.body.removeChild(script);
                delete window[callbackName];
            };
            document.body.appendChild(script);
        };

        // Function to fetch specific cells from CACULATE!
        const fetchSpecificCaculateData = () => {
            // Rows specified by the user
            // F183, H183; F214, H214; F245, H245; F275, H275; F306, H306; F336, H336; F366, H366
            const targetRows = [183, 214, 245, 275, 306, 336, 366];
            const dateCol = 'F'; // Demodate column
            const valueCol = 'H'; // DemoUSDT column

            // Clear previous results and show loading
            specificCaculateDataBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';

            const callbackName = 'jsonpSpecificCaculateCallback_' + Date.now();
            window[callbackName] = (response) => {
                if (response && response.data) {
                    specificCaculateDataBody.innerHTML = ''; // Clear loading
                    response.data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                        const formattedDate = item.date ? formatDate(item.date) : '-'; // Use existing formatDate
                        // Ensure value is formatted as a whole number
                        const formattedValue = item.value !== null && item.value !== undefined ? Math.round(item.value).toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '-';

                        tr.innerHTML = `
                            <td class="py-2 px-4 text-left">${item.row}</td>
                            <td class="py-2 px-4 text-left whitespace-nowrap">${formattedDate}</td>
                            <td class="py-2 px-4 text-left">${formattedValue}</td>
                        `;
                        specificCaculateDataBody.appendChild(tr);
                    });
                } else {
                    specificCaculateDataBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏î‡πâ</td></tr>';
                    console.error('Error fetching specific CACULATE! data:', response.error || 'Unknown error');
                }
                document.body.removeChild(script);
                delete window[callbackName];
            };

            const script = document.createElement('script');
            // Pass parameters for new action
            script.src = `${SCRIPT_URL}?action=fetchSpecificCaculateData&rows=${targetRows.join(',')}&dateColumn=${dateCol}&valueColumn=${valueCol}&callback=${callbackName}`;
            script.onerror = () => {
                specificCaculateDataBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</td></tr>';
                console.error('Failed to connect for specific CACULATE! data.');
                document.body.removeChild(script);
                delete window[callbackName];
            };
            document.body.appendChild(script);
        };


        // Function to fetch data from Google Sheet using JSONP (for Dashboard)
        const fetchData = () => {
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const callbackName = 'jsonpCallback_' + Date.now();
            window[callbackName] = (response) => {
                if (response && response.data) {
                    allDashboardData = response.data; // Store raw data
                    localStorage.setItem('dashboardData', JSON.stringify(allDashboardData));
                    populateMonthFilter(allDashboardData); // Populate filter with new data
                    applyFilter(); // Apply filter to render initial view (default to "all")
                    // Also fetch specific CACULATE! data
                    fetchSpecificCaculateData(); 
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                    });
                }
                document.body.removeChild(script);
                delete window[callbackName];
            };

            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?callback=${callbackName}`;
            script.onerror = () => {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet ‡πÑ‡∏î‡πâ',
                });
                document.body.removeChild(script);
                delete window[callbackName];
            };
            document.body.appendChild(script);
        };

        // Populate date dropdown for the entire year
        const populateDateDropdown = () => {
            const today = new Date();
            const currentYear = today.getFullYear();
            dateSelect.innerHTML = ''; // Clear previous options

            for (let month = 0; month < 12; month++) {
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, month, day);
                    const formattedDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
                    const displayDate = formatDate(formattedDate); // Use the custom formatDate for display in dropdown (Buddhist year)
                    const option = document.createElement('option');
                    option.value = formattedDate;
                    option.textContent = displayDate;
                    dateSelect.appendChild(option);
                }
            }
            // Set default selected date to today for input page
            dateSelect.value = today.toISOString().split('T')[0];
            loadInputDataForDate(); // Load data for the default selected date
        };

        // Event Listeners
        updateDataBtn.addEventListener('click', fetchData);
        applyFilterBtn.addEventListener('click', applyFilter); // Add event listener for the new filter button
        dateSelect.addEventListener('change', loadInputDataForDate); // Listen for date changes on input page

        inputDataPageBtn.addEventListener('click', () => {
            dashboardPage.classList.add('hidden');
            inputPage.classList.remove('hidden');
            populateDateDropdown(); // Populate dropdown and load data for current date when navigating to input page
        });

        backToDashboardBtn.addEventListener('click', () => {
            inputPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            applyFilter(); // Re-apply filter when returning to dashboard to ensure correct display
        });

        saveDataBtn.addEventListener('click', async () => {
            const selectedDate = dateSelect.value;
            const celo = celoInput.value;
            const enj = enjInput.value;
            const wld = wldInput.value;
            const rune = runeInput.value;

            if (!selectedDate || !celo || !enj || !wld || !rune) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!',
                    text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß',
                });
                return;
            }

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        date: selectedDate,
                        // ‡∏Ñ‡∏π‡∏ì‡∏î‡πâ‡∏ß‡∏¢ 0.01 ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        celo: parseFloat(celo) * 0.01,
                        enj: parseFloat(enj) * 0.01,
                        wld: parseFloat(wld) * 0.01,
                        rune: parseFloat(rune) * 0.01
                    }).toString()
                });

                const result = await response.json();

                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        showConfirmButton: false,
                        timer: 1500
                    });

                    // After saving, re-fetch data to update dashboard immediately and also input fields
                    fetchData(); // This will refresh dashboard table and specific CACULATE! table
                    loadInputDataForDate(); // This will refresh input fields for the currently selected date
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                        text: result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                    });
                }
            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet ‡πÑ‡∏î‡πâ: ' + error.message,
                });
            }
        });

        // Initial load logic is now handled in window.onload
        document.addEventListener('DOMContentLoaded', () => {
            populateDateDropdown(); // Call populateDateDropdown to set default date for input page dropdown
        });
    </script>
</body>
</html>
